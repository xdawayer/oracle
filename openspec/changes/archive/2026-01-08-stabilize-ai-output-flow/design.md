<!-- INPUT: AI 输出单语言、合盘分步生成与校验策略设计。 -->
<!-- OUTPUT: OpenSpec 设计说明。 -->
<!-- POS: 变更设计文档；若更新此文件，务必更新本头注释与所属文件夹的 FOLDER.md。 -->
## Context
- 当前 AI 输出要求双语，导致 token 与耗时显著增加，且 JSON 格式错误时整体失败。
- 合盘报告一次性生成全量内容，体量大、失败率高，切换标签后也会出现未完成或错误状态。
- 用户希望默认只生成必要内容（合盘总览），其余按需生成；并且 AI 输出只返回单语言，避免无效成本。

## Goals / Non-Goals
- Goals:
  - 单语言 AI 输出，内容语言由用户当前偏好决定。
  - 合盘按标签分步生成，默认只输出总览。
  - 保持模块完整性，允许缩短非核心模块的文字长度。
  - 全局统一温度配置，输出风格稳定。
  - 默认不设超时，避免因时间限制导致失败。
  - 失败时显示明确错误而非 mock。
- Non-Goals:
  - UI 视觉改版与布局优化不在本次范围。
  - 不引入新的外部模型服务或流式渲染。
  - 不调整 Swiss Ephemeris 的计算逻辑。

## Decisions
- 单语言输出策略：AI 响应仅返回当前语言内容，返回结构包含 `lang` 与 `content`，不保留双语兼容层。
- 生成分步策略：合盘只在默认标签生成 overview，其余标签按 tab 顺序在空闲时预取，若用户先切换则即时触发。
- 模块完整性策略：保持模块结构完整，允许按模块设定长度预算，优先缩减非核心模块文字。
- 校验策略：采用宽松校验与 JSON 修复，避免严格校验导致整体失败。
- 超时策略：默认不设 AI 超时，仅保留手动刷新或用户取消作为控制方式。
- 温度策略：使用全局温度配置，统一所有 AI 输出风格。

## Risks / Trade-offs
- 单语言输出降低即时切换语言的灵活性，需要切换后重新请求。
- 合盘分步请求会增加标签切换时的等待时间。
- 宽松校验可能放过部分结构瑕疵，需要前端容错与提示。
- 取消超时可能导致等待过长，需要 UI 明确状态提示。

## Migration Plan
1. 定义新的 AI 响应结构（单语言）与语言参数传递规则。
2. 更新 prompts 的输出指令，移除双语要求并加入模块长度约束。
3. 调整 AI 服务解析与缓存 key（含 lang）。
4. 合盘接口支持按标签请求与默认 overview。
5. 前端消费新结构，按需请求并展示错误提示。

## Open Questions
- 暂无
