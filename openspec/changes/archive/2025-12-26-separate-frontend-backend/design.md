<!-- INPUT: 架构拆分、数据分层与缓存策略（含选型确认）。 -->
<!-- OUTPUT: OpenSpec 设计说明文档。 -->
<!-- POS: 设计决策记录（已确认选型）；若更新此文件，务必更新本头注释与所属文件夹的 FOLDER.md。 -->
## 背景与约束
- 当前数据与 AI 内容主要由前端 mock 提供，缺少可上线的后端实现。
- 需要建立清晰的前后端边界，后端负责真实数据与 AI 内容生成。
- 所有文本数据需同时提供 zh/en 双语版本。

## 目标 / 非目标
- 目标：前端只负责表现层与交互，所有数据由后端 API 提供。
- 目标：引入真实天文数据计算与 AI 解读服务。
- 目标：建立可控的缓存策略与 Prompt 管理机制。
- 非目标：重构非必要的 UI 样式或交互模式。

## 关键决策
- 数据分层：
  - Real Data：基于用户输入与天文数据源计算（行星位置、宫位、相位等）。
  - AI Data：基于用户数据与问题，使用模型与 Prompt 生成解读内容。
- 前端接口：统一通过后端 API 获取 Real Data 与 AI Data，不再直接读取本地 mock。
- i18n 输出：后端返回的文本字段必须包含 `zh` 与 `en` 两份内容，前端按用户语言选择。
- Prompt 管理：每个页面/场景拥有独立 Prompt，按功能与版本管理（例如本命盘、日运、合盘、问答等）。

## 已确认
- 技术栈：独立后端服务（Node.js/TypeScript）+ 前端静态部署。
- 数据库与缓存：PostgreSQL（持久化）+ Redis（缓存与 TTL）。
- 真实数据源：Swiss Ephemeris 与 NASA 共同使用。
- 用户身份体系：正式版本为邮件注册；当前阶段以本地测试为主。
- 选择理由：独立后端适合重计算与缓存，避免 Serverless 冷启动与资源限制。

## 数据与接口建议
- 基础数据 API：用户输入、星盘基础数据、行运与周期数据。
- AI 生成 API：本命盘解读、维度分析、日运深度解读、合盘报告、Oracle 问答、CBT 分析。
- 统一响应格式：包含数据版本、语言包、缓存元信息（如 `cache_key`, `expires_at`）。

## 缓存策略
- 用户输入：长期缓存，用户修改时才更新。
- 本命盘数据：与用户输入绑定，用户修改时重新计算。
- 行运/周期数据：按日期范围缓存，过期后刷新。
- 合盘数据：由两人输入决定，任一方变化时重新生成。
- AI 输出：按输入数据 + Prompt 版本作为缓存键，避免重复生成。

## 风险与权衡
- 引入后端后需要处理网络错误与降级体验。
- 双语输出与 Prompt 版本管理增加后端复杂度。
- 数据源接口（Swiss/NASA）与授权成本需评估。

## 迁移计划
1. 定义后端 API 与数据模型（Real Data 与 AI Data）。
2. 在前端替换所有 mock 数据获取逻辑。
3. 建立缓存层与失效策略。
4. 补齐双语数据输出与 Prompt 管理。
